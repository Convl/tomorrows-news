<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard ‚Ä¢ Tomorrow's News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/app/assets/theme.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container">
            <a class="navbar-brand text-primary" href="/app/dashboard.html">Tomorrow's News</a>
            <div class="d-flex ms-auto">
                <button id="logout" class="btn btn-outline-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <div class="main-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <div class="icon-placeholder icon-topic me-3">üìë</div>
                    <h1 class="h3 mb-0 fw-semibold">Your Topics</h1>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="collapse-all-switch" checked>
                        <label class="form-check-label small" for="collapse-all-switch">Expand all topics</label>
                    </div>
                    <a class="btn btn-primary" href="/app/topic-new.html">‚ûï New Topic</a>
                </div>
            </div>
            <div id="alert" class="alert d-none" role="alert"></div>
            <div id="topics" class="vstack gap-4"></div>
        </div>
    </main>

    <script type="module" src="/app/js/config.js"></script>
    <script type="module">
        import { apiBase, getToken, authHeaders, clearToken } from '/app/js/config.js';
        const alertEl = document.getElementById('alert');
        const token = getToken();
        if (!token) { window.location.href = '/app/login.html'; }

        document.getElementById('logout').onclick = () => { clearToken(); window.location.href = '/app/login.html'; };

        async function fetchTopics() {
            try {
                const resp = await fetch(`${apiBase}/topics/?limit=100`, { headers: authHeaders() });
                if (!resp.ok) throw new Error('Failed to load topics');
                const topics = await resp.json();
                // Fetch sources and initial upcoming events for each topic in parallel
                const [sourcesPairs, eventsPairs] = await Promise.all([
                    Promise.all(topics.map(async (t) => {
                        try { return [t.id, await fetchSources(t.id)]; } catch { return [t.id, []]; }
                    })),
                    Promise.all(topics.map(async (t) => {
                        try { return [t.id, await fetchUpcomingEvents(t.id, 20, true, 0)]; } catch { return [t.id, []]; }
                    })),
                ]);
                const sourcesByTopic = Object.fromEntries(sourcesPairs);
                const eventsByTopic = Object.fromEntries(eventsPairs);
                renderTopics(topics, sourcesByTopic, eventsByTopic);
                startPolling(topics.map(t => t.id));
                // Initialize global collapse switch state
                setTimeout(updateCollapseAllSwitch, 100);
            } catch (err) {
                alertEl.textContent = err.message || 'Failed to load topics';
                alertEl.className = 'alert alert-danger';
            }
        }

        async function fetchSources(topicId) {
            const resp = await fetch(`${apiBase}/scraping-sources/?topic_id=${encodeURIComponent(topicId)}&limit=100`, { headers: authHeaders() });
            if (!resp.ok) throw new Error('Failed to load sources');
            return await resp.json();
        }

        async function fetchUpcomingEvents(topicId, limit = 20, includeExtracted = true, skip = 0) {
            const params = new URLSearchParams({
                topic_id: String(topicId),
                limit: String(limit),
                skip: String(skip),
            });
            if (includeExtracted) params.set('include_extracted', 'true');
            const resp = await fetch(`${apiBase}/events/?${params.toString()}`, { headers: authHeaders() });
            if (!resp.ok) throw new Error('Failed to load events');
            return await resp.json();
        }

        const topicState = {};

        // Sort state: default to date ascending
        const sortState = {
            field: 'date',      // 'date' or 'significance'
            direction: 'asc'    // 'asc' or 'desc'
        };

        function sortEvents(events, field = 'date', direction = 'asc') {
            const sortedEvents = [...events].sort((a, b) => {
                let valueA, valueB;

                if (field === 'date') {
                    valueA = new Date(a.date);
                    valueB = new Date(b.date);
                } else if (field === 'significance') {
                    valueA = a.significance || 0;
                    valueB = b.significance || 0;
                }

                if (direction === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });

            return sortedEvents;
        }

        function renderTopics(topics, sourcesByTopic, eventsByTopic) {
            const container = document.getElementById('topics');
            container.innerHTML = '';
            if (!topics.length) {
                container.innerHTML = '<div class="text-secondary">No topics yet.</div>';
                return;
            }
            topics.forEach((t) => {
                const card = document.createElement('div');
                card.className = 'card topic-card';
                card.innerHTML = `
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-start flex-grow-1">
                  <div class="icon-placeholder icon-topic me-3">üìë</div>
                  <div class="flex-grow-1">
                    <h2 class="h5 mb-1">${t.name}</h2>
                    <div class="text-secondary small">${t.description || ''}</div>
                  </div>
                </div>
                <div class="ms-3 flex-shrink-0 d-flex align-items-start gap-3">
                  <div class="form-check form-switch mt-1">
                    <input class="form-check-input" type="checkbox" id="topic-expand-${t.id}" checked>
                    <label class="form-check-label small" for="topic-expand-${t.id}">Expand topic</label>
                  </div>
                  <div class="d-flex gap-2">
                    <a class="btn btn-sm btn-outline-secondary" href="/app/topic-edit.html?id=${t.id}">‚úèÔ∏è Edit</a>
                    <a class="btn btn-sm btn-primary" href="/app/source-new.html?topic_id=${t.id}">‚ûï Add Feed</a>
                  </div>
                </div>
              </div>
              
              <div class="collapse show" id="topic-content-${t.id}">
                <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
                  <h3 class="h6 mb-0 d-flex align-items-center">
                    <div class="icon-placeholder icon-topic me-2">üì°</div>
                    <span>Feeds <span class="text-muted" id="feeds-count-${t.id}"></span></span>
                  </h3>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="sources-expand-${t.id}" checked>
                    <label class="form-check-label small" for="sources-expand-${t.id}">Expand feeds</label>
                  </div>
                </div>
                <div class="collapse show" id="sources-content-${t.id}">
                  <div id="sources-${t.id}"></div>
                </div>
                <hr class="my-4" />
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h3 class="h6 mb-0 d-flex align-items-center">
                    <div class="icon-placeholder icon-event me-2">üìÖ</div>
                    <span>Upcoming events <span class="text-muted" id="events-count-${t.id}"></span></span>
                  </h3>
                  <div class="d-flex align-items-center gap-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="events-expand-${t.id}" checked>
                      <label class="form-check-label small" for="events-expand-${t.id}">Expand events</label>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="small text-muted">Sort:</span>
                      <select class="form-select form-select-sm event-sort-field" id="sort-field-${t.id}" style="width: auto;">
                        <option value="date">Date</option>
                        <option value="significance">Significance</option>
                      </select>
                      <button class="btn btn-outline-secondary btn-sm event-sort-direction" id="sort-direction-${t.id}" title="Toggle sort direction">
                        <span class="sort-text">Ascending</span>
                      </button>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="toggle-all-sources-${t.id}">
                      <label class="form-check-label small" for="toggle-all-sources-${t.id}">Show all sources</label>
                    </div>
                  </div>
                </div>
                <div class="collapse show" id="events-content-${t.id}">
                  <div id="events-${t.id}"></div>
                  <div class="d-grid mt-3">
                    <button class="btn btn-outline-secondary btn-sm" id="show-more-${t.id}">Show more</button>
                  </div>
                </div>
              </div>
            </div>
          `;
                container.appendChild(card);
                const sources = sourcesByTopic[t.id] || [];
                const sEl = card.querySelector(`#sources-${t.id}`);
                if (!sources.length) {
                    sEl.innerHTML = '<div class="text-secondary">No sources.</div>';
                    // Update feeds count for empty case
                    const feedsCountEl = card.querySelector(`#feeds-count-${t.id}`);
                    feedsCountEl.textContent = '';
                }
                const list = document.createElement('div');
                list.className = 'list-group list-group-flush';
                sources.forEach(s => {
                    const iconMap = { 'Webpage': 'üåê', 'Rss': 'üì°', 'Api': 'üîó' };
                    const iconClass = s.source_type === 'Webpage' ? 'icon-web' : s.source_type === 'Rss' ? 'icon-rss' : 'icon-api';
                    const row = document.createElement('div');
                    row.className = 'list-group-item';
                    row.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <div class="icon-placeholder ${iconClass} me-3">${iconMap[s.source_type] || 'üîó'}</div>
                    <div>
                      <div class="fw-semibold">${s.name} <span class="badge text-bg-light">${s.source_type}</span></div>
                      <div class="small text-secondary">${s.base_url}</div>
                    </div>
                  </div>
                  <div>
                    <a class="btn btn-sm btn-outline-secondary" href="/app/source-edit.html?id=${s.id}">‚úèÔ∏è Edit</a>
                  </div>
                </div>`;
                    list.appendChild(row);
                });
                sEl.innerHTML = '';
                sEl.appendChild(list);

                // Update feeds count
                const feedsCountEl = card.querySelector(`#feeds-count-${t.id}`);
                feedsCountEl.textContent = sources.length > 0 ? `(${sources.length})` : '';

                // Initialize topic state
                topicState[t.id] = topicState[t.id] || { limit: 20, skip: 0, showSourcesGlobal: false, expanded: new Set(), events: [] };
                topicState[t.id].events = eventsByTopic[t.id] || [];

                // Render events
                renderEventsForTopic(t.id);

                // Wire global toggle
                const toggleAll = card.querySelector(`#toggle-all-sources-${t.id}`);
                toggleAll.checked = topicState[t.id].showSourcesGlobal;
                toggleAll.onchange = () => {
                    topicState[t.id].showSourcesGlobal = !!toggleAll.checked;
                    renderEventsForTopic(t.id);
                };

                // Wire Show more
                const showMoreBtn = card.querySelector(`#show-more-${t.id}`);
                showMoreBtn.onclick = async () => {
                    try {
                        topicState[t.id].limit += 20;
                        const newEvents = await fetchUpcomingEvents(t.id, 20, true, topicState[t.id].events.length);
                        topicState[t.id].events = topicState[t.id].events.concat(newEvents);
                        renderEventsForTopic(t.id);
                    } catch (e) {
                        console.error(e);
                    }
                };

                // Wire collapse functionality
                // Wire topic collapse switch
                const topicContent = card.querySelector(`#topic-content-${t.id}`);
                const topicSwitch = card.querySelector(`#topic-expand-${t.id}`);
                const topicLabel = card.querySelector(`label[for="topic-expand-${t.id}"]`);

                topicSwitch.onchange = () => {
                    if (topicSwitch.checked) {
                        topicContent.classList.add('show');
                        topicLabel.textContent = 'Expand topic';
                    } else {
                        topicContent.classList.remove('show');
                        topicLabel.textContent = 'Collapse topic';
                    }
                    setTimeout(updateCollapseAllSwitch, 100);
                };

                // Wire sources collapse switch
                const sourcesContent = card.querySelector(`#sources-content-${t.id}`);
                const sourcesSwitch = card.querySelector(`#sources-expand-${t.id}`);
                const sourcesLabel = card.querySelector(`label[for="sources-expand-${t.id}"]`);

                sourcesSwitch.onchange = () => {
                    if (sourcesSwitch.checked) {
                        sourcesContent.classList.add('show');
                        sourcesLabel.textContent = 'Expand feeds';
                    } else {
                        sourcesContent.classList.remove('show');
                        sourcesLabel.textContent = 'Collapse feeds';
                    }
                };

                // Wire events collapse switch
                const eventsContent = card.querySelector(`#events-content-${t.id}`);
                const eventsSwitch = card.querySelector(`#events-expand-${t.id}`);
                const eventsLabel = card.querySelector(`label[for="events-expand-${t.id}"]`);

                eventsSwitch.onchange = () => {
                    if (eventsSwitch.checked) {
                        eventsContent.classList.add('show');
                        eventsLabel.textContent = 'Expand events';
                    } else {
                        eventsContent.classList.remove('show');
                        eventsLabel.textContent = 'Collapse events';
                    }
                };

                // Wire sorting controls
                const sortFieldSelect = card.querySelector(`#sort-field-${t.id}`);
                const sortDirectionBtn = card.querySelector(`#sort-direction-${t.id}`);
                const sortText = sortDirectionBtn.querySelector('.sort-text');

                // Initialize topic sorting state
                if (!topicState[t.id].sortField) {
                    topicState[t.id].sortField = sortState.field;
                    topicState[t.id].sortDirection = sortState.direction;
                }

                // Set initial UI state
                sortFieldSelect.value = topicState[t.id].sortField;
                sortText.textContent = topicState[t.id].sortDirection === 'asc' ? 'Ascending' : 'Descending';
                sortDirectionBtn.title = `Sort ${topicState[t.id].sortDirection === 'asc' ? 'ascending' : 'descending'}`;

                // Sort field change handler
                sortFieldSelect.onchange = () => {
                    topicState[t.id].sortField = sortFieldSelect.value;
                    renderEventsForTopic(t.id);
                };

                // Sort direction toggle handler
                sortDirectionBtn.onclick = () => {
                    const currentDirection = topicState[t.id].sortDirection;
                    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                    topicState[t.id].sortDirection = newDirection;

                    // Update UI
                    sortText.textContent = newDirection === 'asc' ? 'Ascending' : 'Descending';
                    sortDirectionBtn.title = `Sort ${newDirection === 'asc' ? 'ascending' : 'descending'}`;

                    renderEventsForTopic(t.id);
                };
            });
        }

        function renderEventsForTopic(topicId) {
            const container = document.querySelector(`#events-${topicId}`);
            const data = topicState[topicId];
            const rawEvents = data.events || [];
            if (!rawEvents.length) {
                container.innerHTML = '<div class="text-secondary">No upcoming events.</div>';
                // Update events count
                const eventsCountEl = document.querySelector(`#events-count-${topicId}`);
                eventsCountEl.textContent = '';
                return;
            }

            // Apply sorting
            const sortField = data.sortField || sortState.field;
            const sortDirection = data.sortDirection || sortState.direction;
            const events = sortEvents(rawEvents, sortField, sortDirection);
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'vstack gap-3';
            events.forEach(ev => {
                const evId = ev.id;
                const expanded = data.expanded.has(evId) || data.showSourcesGlobal;
                const dateStr = new Date(ev.date).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const addl = ev.additional_infos && Object.entries(ev.additional_infos).length
                    ? Object.entries(ev.additional_infos).map(([k, v]) => `<span class="badge text-bg-light me-1 mb-1">"${k}: ${v}"</span>`).join(' ')
                    : '';

                // Determine confidence level styling
                const confidence = Math.round((ev.significance || 0) * 100);
                let confidenceClass = 'confidence-low';
                if (confidence >= 70) confidenceClass = 'confidence-high';
                else if (confidence >= 60) confidenceClass = 'confidence-medium';

                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.innerHTML = `
                    <div class="d-flex align-items-start gap-3">
                      <div class="icon-placeholder icon-event flex-shrink-0">üìÖ</div>
                      <div class="flex-grow-1 min-w-0">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <div class="flex-grow-1 min-w-0 me-3">
                            <h4 class="h6 mb-1 fw-semibold">${ev.title}</h4>
                            <div class="small text-secondary mb-2">
                              <span class="fw-medium">üìÖ ${dateStr}</span>
                              ${ev.location ? ` ‚Ä¢ <span class="fw-medium">üìç ${ev.location}</span>` : ''}
                            </div>
                          </div>
                          <div class="flex-shrink-0">
                            <span class="confidence-badge ${confidenceClass}" title="Significance rating for this event, based on the nature of the event, its importance to the topic, and the likelihood of the event coming to pass">${confidence}%</span>
                          </div>
                        </div>
                        ${ev.description ? `<div class="mb-3 fw-medium text-dark">${ev.description}</div>` : ''}
                        ${addl ? `<div class="mb-2"><small class="text-muted fw-medium">Additional Info:</small><br/>${addl}</div>` : ''}
                        <div class="text-end">
                          <div class="form-check form-switch d-inline-flex align-items-center">
                            <input class="form-check-input" type="checkbox" id="event-sources-${evId}" ${expanded ? 'checked' : ''}>
                            <label class="form-check-label small ms-2" for="event-sources-${evId}">${expanded ? 'Hide sources' : 'Show sources'}</label>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3 ${expanded ? '' : 'd-none'}" id="ev-sources-${evId}"></div>
                `;
                eventsContainer.appendChild(eventDiv);
                // Render extracted events list
                const tgt = eventDiv.querySelector(`#ev-sources-${evId}`);
                renderExtractedEvents(tgt, ev.extracted_events || []);
                // Wire per-event toggle
                const sourceSwitch = eventDiv.querySelector(`#event-sources-${evId}`);
                const sourceLabel = eventDiv.querySelector(`label[for="event-sources-${evId}"]`);
                sourceSwitch.onchange = () => {
                    if (sourceSwitch.checked) {
                        data.expanded.add(evId);
                        sourceLabel.textContent = 'Show sources';
                    } else {
                        data.expanded.delete(evId);
                        sourceLabel.textContent = 'Hide sources';
                    }
                    renderEventsForTopic(topicId);
                };
            });
            container.innerHTML = '';
            container.appendChild(eventsContainer);

            // Update events count
            const eventsCountEl = document.querySelector(`#events-count-${topicId}`);
            eventsCountEl.textContent = events.length > 0 ? `(${events.length})` : '';
        }

        function renderExtractedEvents(container, extracted) {
            if (!extracted.length) {
                container.innerHTML = '<div class="text-secondary small">No sources for this event.</div>';
                return;
            }
            const sourcesDiv = document.createElement('div');
            sourcesDiv.className = 'vstack gap-2';
            extracted.forEach(x => {
                const dateStr = new Date(x.source_published_date).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const addl = x.additional_infos && Object.entries(x.additional_infos).length
                    ? Object.entries(x.additional_infos).map(([k, v]) => `<span class=\"badge text-bg-light me-1 mb-1\">"${k}: ${v}"</span>`).join(' ')
                    : '';
                const sourceItem = document.createElement('div');
                sourceItem.className = 'source-item';
                sourceItem.innerHTML = `
                    <div class="d-flex align-items-start">
                      <div class="icon-placeholder icon-web me-2">üîó</div>
                      <div class="flex-grow-1">
                        <div class="fw-semibold small">
                          <a href="${x.source_url}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                            ${x.source_title || 'Article'}
                          </a>
                        </div>
                        <div class="small text-secondary">
                          üìÖ Published ${dateStr} ‚Ä¢ üîó hops: ${x.degrees_of_separation}
                        </div>
                        ${addl ? `<div class="mt-1">${addl}</div>` : ''}
                      </div>
                    </div>
                `;
                sourcesDiv.appendChild(sourceItem);
            });
            container.innerHTML = '';
            container.appendChild(sourcesDiv);
        }

        function startPolling(topicIds) {
            setInterval(async () => {
                try {
                    const pairs = await Promise.all(topicIds.map(async (tid) => {
                        const limit = topicState[tid]?.events?.length || 20;
                        const events = await fetchUpcomingEvents(tid, limit, true, 0);
                        return [tid, events];
                    }));
                    for (const [tid, events] of pairs) {
                        if (!topicState[tid]) continue;
                        topicState[tid].events = events;
                        renderEventsForTopic(tid);
                    }
                } catch (e) {
                    console.error('Polling failed', e);
                }
            }, 30000);
        }

        // Global collapse/expand functionality
        const collapseAllSwitch = document.getElementById('collapse-all-switch');
        const collapseAllLabel = document.querySelector('label[for="collapse-all-switch"]');

        function updateCollapseAllSwitch() {
            const allTopicCollapses = document.querySelectorAll('[id^="topic-content-"]');
            const expandedCount = Array.from(allTopicCollapses).filter(el => el.classList.contains('show')).length;

            if (expandedCount === allTopicCollapses.length && allTopicCollapses.length > 0) {
                collapseAllSwitch.checked = true;
                collapseAllLabel.textContent = 'Expand all topics';
            } else if (expandedCount === 0 && allTopicCollapses.length > 0) {
                collapseAllSwitch.checked = false;
                collapseAllLabel.textContent = 'Collapse all topics';
            } else {
                // Mixed state - some expanded, some collapsed
                collapseAllSwitch.checked = false;
                collapseAllLabel.textContent = 'Expand all topics';
            }
        }

        collapseAllSwitch.onchange = () => {
            const shouldExpand = collapseAllSwitch.checked;
            const allTopicCollapses = document.querySelectorAll('[id^="topic-content-"]');
            const allSourceCollapses = document.querySelectorAll('[id^="sources-content-"]');
            const allEventCollapses = document.querySelectorAll('[id^="events-content-"]');

            if (shouldExpand) {
                // Expand all
                allTopicCollapses.forEach(el => {
                    el.classList.add('show');
                });
                allSourceCollapses.forEach(el => {
                    el.classList.add('show');
                });
                allEventCollapses.forEach(el => {
                    el.classList.add('show');
                });
                collapseAllLabel.textContent = 'Expand all topics';
                // Update individual switches
                document.querySelectorAll('[id^="topic-expand-"]').forEach(switchEl => {
                    switchEl.checked = true;
                    const label = document.querySelector(`label[for="${switchEl.id}"]`);
                    if (label) label.textContent = 'Expand topic';
                });
                document.querySelectorAll('[id^="sources-expand-"]').forEach(switchEl => {
                    switchEl.checked = true;
                    const label = document.querySelector(`label[for="${switchEl.id}"]`);
                    if (label) label.textContent = 'Expand feeds';
                });
                document.querySelectorAll('[id^="events-expand-"]').forEach(switchEl => {
                    switchEl.checked = true;
                    const label = document.querySelector(`label[for="${switchEl.id}"]`);
                    if (label) label.textContent = 'Expand events';
                });
            } else {
                // Collapse all
                allTopicCollapses.forEach(el => {
                    el.classList.remove('show');
                });
                allSourceCollapses.forEach(el => {
                    el.classList.remove('show');
                });
                allEventCollapses.forEach(el => {
                    el.classList.remove('show');
                });
                collapseAllLabel.textContent = 'Collapse all topics';
                // Update individual switches
                document.querySelectorAll('[id^="topic-expand-"]').forEach(switchEl => {
                    switchEl.checked = false;
                    const label = document.querySelector(`label[for="${switchEl.id}"]`);
                    if (label) label.textContent = 'Collapse topic';
                });
                document.querySelectorAll('[id^="sources-expand-"]').forEach(switchEl => {
                    switchEl.checked = false;
                    const label = document.querySelector(`label[for="${switchEl.id}"]`);
                    if (label) label.textContent = 'Collapse feeds';
                });
                document.querySelectorAll('[id^="events-expand-"]').forEach(switchEl => {
                    switchEl.checked = false;
                    const label = document.querySelector(`label[for="${switchEl.id}"]`);
                    if (label) label.textContent = 'Collapse events';
                });
            }
        };

        fetchTopics();
    </script>
</body>

</html>