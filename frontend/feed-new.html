<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Feed ‚Ä¢ Tomorrow's News</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/app/assets/theme.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <main class="container py-5">
    <div class="main-container">
      <a href="/app/dashboard.html" class="btn btn-link mb-4">‚Üê Back</a>
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center mb-4">
            <div class="icon-placeholder icon-web me-3">üì°</div>
            <h1 class="h4 mb-0 fw-semibold">Create Feed</h1>
          </div>
          <div id="alert" class="alert d-none" role="alert"></div>
          <div id="form"></div>
          <div class="d-grid gap-2 mt-4">
            <button id="submit" class="btn btn-primary">‚úÖ Create Feed</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module" src="/app/js/config.js"></script>
  <script type="module" src="/app/js/choices.js"></script>
  <script type="module" src="/app/js/field-help.js"></script>
  <script type="module">
    import { apiBase, authHeaders, getToken } from '/app/js/config.js';
    import { fetchCountryOptions, fetchLanguageOptions, fetchSourceTypeOptions, populateSelect } from '/app/js/choices.js';
    import { addHelpIcon, addHelpText, addSelectDynamicHelp, HELP_TEXTS } from '/app/js/field-help.js';
    const alertEl = document.getElementById('alert');
    if (!getToken()) { window.location.href = '/app/login.html'; }
    const formRoot = document.getElementById('form');
    formRoot.innerHTML = `
            <div class="mb-4">
              <label class="form-label" for="name">üìù Name <span class="text-secondary">(required)</span></label>
              <input class="form-control" id="name" required placeholder="e.g., Presseschau der LTO" />
            </div>
            <div class="mb-4">
              <label class="form-label" for="base_url">üîó Base URL <span class="text-secondary">(required)</span></label>
              <input class="form-control" id="base_url" type="url" required placeholder="https://example.com" />
            </div>
            <div class="mb-4">
              <label class="form-label" for="source_type">üîß Source Type <span class="text-secondary">(required)</span></label>
              <select class="form-select" id="source_type" required></select>
            </div>
            <div class="mb-4">
              <label class="form-label" for="language">üó£Ô∏è Language</label>
              <select class="form-select" id="language"></select>
            </div>
            <div class="mb-4">
              <label class="form-label" for="degrees_of_separation">üîó Degrees of separation</label>
              <select class="form-select" id="degrees_of_separation">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="3">3</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="form-label" for="scraping_frequency">‚è±Ô∏è Scraping frequency</label>
              <div class="row g-2">
                <div class="col-8">
                  <input class="form-control" id="scraping_frequency_value" type="number" min="1" value="1" />
                </div>
                <div class="col-4">
                  <select class="form-select" id="scraping_frequency_unit">
                    <option value="days" selected>Days</option>
                    <option value="hours">Hours</option>
                    <option value="minutes">Minutes</option>
                  </select>
                </div>
              </div>
            </div>
        `;
    const submitBtn = document.getElementById('submit');
    const params = new URLSearchParams(window.location.search);
    const topicId = parseInt(params.get('topic_id'), 10);
    async function init() {
      populateSelect(document.getElementById('language'), await fetchLanguageOptions(true));
      populateSelect(document.getElementById('source_type'), await fetchSourceTypeOptions());

      // Initialize help system
      setupFieldHelp();
    }

    function setupFieldHelp() {
      // Add help icons with new comprehensive explanations
      addHelpIcon('label[for="name"]', 'Source name, e.g. "Presseschau der LTO", "Politikressort der F.A.Z.", "Pressemitteilungen des Bundesgerichtshofs"');

      addHelpIcon('label[for="base_url"]', 'Webpage or RSS feed URL that will contain the news, e.g. https://www.bundesgerichtshof.de/DE/Presse/Pressemitteilungen/pressemitteilungen_node.html, https://www.lto.de/presseschau-rss/rss/feed.xml');

      addHelpIcon('label[for="scraping_frequency"]', 'How often this feed shall be scraped for new events (minimum: 1 day / 24 hours / 1440 minutes)');

      addHelpIcon('label[for="degrees_of_separation"]', 'Where information about upcoming events is expected to be found, relative to the base url.<br><br><strong>1</strong> = News content found DIRECTLY ON THE BASE URL, such as with a long-running liveblog. This option is rare / exotic)<br><br><strong>2</strong> = News content LINKED TO FROM THE BASE URL, such as with the base url or specific subsections (politics, business, etc) of any online news outlet. This option is by far the most common<br><br><strong>3</strong> = News content LINKED TO FROM THE BASE URL, but contains further links, which must also be scraped. Use this option for press reviews or similar types of curated overviews, e.g. https://www.lto.de/recht/presseschau');

      // Add dynamic help for source type dropdown
      addSelectDynamicHelp('#source_type', HELP_TEXTS.SOURCE_TYPES, 'Select how you want to monitor this source for new content.');
    }
    submitBtn.onclick = async () => {
      alertEl.className = 'alert d-none';
      const languageEl = document.getElementById('language');

      // Convert scraping frequency to minutes
      const frequencyValue = parseInt(document.getElementById('scraping_frequency_value').value, 10) || 1;
      const frequencyUnit = document.getElementById('scraping_frequency_unit').value;
      let scrapingFrequencyMinutes;

      switch (frequencyUnit) {
        case 'days':
          scrapingFrequencyMinutes = frequencyValue * 24 * 60;
          break;
        case 'hours':
          scrapingFrequencyMinutes = frequencyValue * 60;
          break;
        case 'minutes':
          scrapingFrequencyMinutes = frequencyValue;
          break;
        default:
          scrapingFrequencyMinutes = 1440; // Default to 1 day
      }

      // Ensure minimum of 1440 minutes (1 day)
      scrapingFrequencyMinutes = Math.max(scrapingFrequencyMinutes, 1440);

      const payload = {
        name: document.getElementById('name').value.trim(),
        base_url: document.getElementById('base_url').value.trim(),
        source_type: document.getElementById('source_type').value,
        language: languageEl.options[languageEl.selectedIndex]?.dataset?.name || (languageEl.value || null),
        language_code: languageEl.value || null,
        degrees_of_separation: parseInt(document.getElementById('degrees_of_separation').value, 10) || 2,
        scraping_frequency: scrapingFrequencyMinutes,
        is_active: true, // Always set to active
        topic_id: topicId,
      };
      if (!payload.name || !payload.base_url || !payload.source_type) {
        alertEl.textContent = 'Name, Base URL, and Source Type are required';
        alertEl.className = 'alert alert-danger';
        return;
      }
      try {
        const resp = await fetch(`${apiBase}/scraping-sources/`, { method: 'POST', headers: authHeaders(), body: JSON.stringify(payload) });
        if (!resp.ok) throw new Error('Failed to create source');
        window.location.href = '/app/dashboard.html';
      } catch (err) {
        alertEl.textContent = err.message || 'Failed to create source';
        alertEl.className = 'alert alert-danger';
      }
    };
    init();
  </script>
</body>

</html>