<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Feed ‚Ä¢ Tomorrow's News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="/app/assets/theme.css" rel="stylesheet" />
    <style>
        .custom-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 400px;
            z-index: 1050;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            white-space: pre-line;
            display: none;
        }
        .custom-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: #333;
        }
        .tooltip-trigger {
            position: relative;
        }
    </style>
</head>

<body class="bg-light">
    <main class="container py-5">
        <div class="main-container">
            <a href="/app/dashboard.html" class="btn btn-link mb-4">‚Üê Back</a>
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="icon-placeholder icon-web me-3">üì°</div>
                        <h1 class="h4 mb-0 fw-semibold">Edit Feed</h1>
                    </div>
                    <div id="alert" class="alert d-none" role="alert"></div>
                    <div id="form"></div>
                    <div class="d-grid gap-2 mt-4">
                        <button id="save" class="btn btn-primary">üíæ Save Changes</button>
                        <button id="delete" class="btn btn-outline-danger">üóëÔ∏è Delete Feed</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="/app/js/config.js"></script>
    <script type="module" src="/app/js/choices.js"></script>
    <script type="module">
        import { apiBase, authHeaders, getToken } from '/app/js/config.js';
        import { fetchCountryOptions, fetchLanguageOptions, fetchSourceTypeOptions, populateSelect } from '/app/js/choices.js';
        const alertEl = document.getElementById('alert');
        if (!getToken()) { window.location.href = '/app/login.html'; }
        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get('id'), 10);
        const formRoot = document.getElementById('form');
        formRoot.innerHTML = `
            <div class="mb-4">
              <label class="form-label" for="name">üìù Name 
                <span class="text-info ms-1 tooltip-trigger" data-tooltip="Source name, e.g. 'Presseschau der LTO', 'Politikressort der F.A.Z.', 'Pressemitteilungen des Bundesgerichtshofs'" style="cursor: help;">‚ÑπÔ∏è</span>
              </label>
              <input class="form-control" id="name" placeholder="Enter source name..." />
            </div>
            <div class="mb-4">
              <label class="form-label" for="base_url">üîó Base URL 
                <span class="text-info ms-1 tooltip-trigger" data-tooltip="Webpage or RSS feed URL that will contain the news, e.g. https://www.bundesgerichtshof.de/DE/Presse/Pressemitteilungen/pressemitteilungen_node.html, https://www.lto.de/presseschau-rss/rss/feed.xml" style="cursor: help;">‚ÑπÔ∏è</span>
              </label>
              <input class="form-control" id="base_url" type="url" placeholder="https://example.com" />
            </div>
            <div class="mb-4">
              <label class="form-label" for="source_type">üîß Source Type 
                <span class="text-info ms-1 tooltip-trigger" data-tooltip="Whether the base url you provided points to a web page like https://www.lto.de/recht/presseschau or a Rss feed like https://www.lto.de/presseschau-rss/rss/feed.xml or a REST Api (coming soon)" style="cursor: help;">‚ÑπÔ∏è</span>
              </label>
              <select class="form-select" id="source_type"></select>
            </div>
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label" for="country">üåç Country 
                  <span class="text-info ms-1 tooltip-trigger" data-tooltip="The country where this feed resides, e.g. &quot;United States&quot; for the New York Times, or &quot;Germany&quot; for the F.A.Z." style="cursor: help;">‚ÑπÔ∏è</span>
                </label>
                <select class="form-select" id="country"></select>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="language">üó£Ô∏è Language 
                  <span class="text-info ms-1 tooltip-trigger" data-tooltip="The language in which events extracted from this feed should appear. This should typically be the same language that is used by the feed itself, and correspond to the feed's country, i.e. &quot;English (en)&quot; for the New York Times or &quot;German (de)&quot; for the F.A.Z." style="cursor: help;">‚ÑπÔ∏è</span>
                </label>
                <select class="form-select" id="language"></select>
              </div>
            </div>
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label" for="degrees_of_separation">üîó Degrees of separation 
                  <span class="text-info ms-1 tooltip-trigger" data-tooltip="Where information about upcoming events is expected to be found, relative to the base url.\n1 = News content found DIRECTLY ON THE BASE URL, such as with a long-running liveblog. This option is rare / exotic\n2 = News content LINKED TO FROM THE BASE URL, such as with the base url or specific subsections (politics, business, etc) of any online news outlet. This option is by far the most common\n3 = News content LINKED TO FROM THE BASE URL, but contains further links, which must also be scraped. Use this option for press reviews or similar types of curated overviews, e.g. https://www.lto.de/recht/presseschau" style="cursor: help;">‚ÑπÔ∏è</span>
                </label>
                <select class="form-select" id="degrees_of_separation">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="scraping_frequency">‚è±Ô∏è Scraping frequency 
                  <span class="text-info ms-1 tooltip-trigger" data-tooltip="How often this feed shall be scraped for new events (minimum: 1 day / 24 hours / 1440 minutes)" style="cursor: help;">‚ÑπÔ∏è</span>
                </label>
                <div class="input-group">
                  <input class="form-control" id="scraping_frequency" type="number" min="1" />
                  <select class="form-select" id="frequency_unit" style="max-width: 120px;">
                    <option value="minutes">Minutes</option>
                    <option value="hours">Hours</option>
                    <option value="days">Days</option>
                  </select>
                </div>
              </div>
            </div>
        `;
        const saveBtn = document.getElementById('save');
        let original = null;
        async function init() {
            const resp = await fetch(`${apiBase}/scraping-sources/${id}`, { headers: authHeaders() });
            if (!resp.ok) { alertEl.textContent = 'Failed to load source'; alertEl.className = 'alert alert-danger'; return; }
            original = await resp.json();
            populateSelect(document.getElementById('country'), await fetchCountryOptions(true), original.country_code || '');
            populateSelect(document.getElementById('language'), await fetchLanguageOptions(true), original.language_code || '');
            populateSelect(document.getElementById('source_type'), await fetchSourceTypeOptions(), original.source_type || '');
            document.getElementById('name').value = original.name || '';
            document.getElementById('base_url').value = original.base_url || '';
            document.getElementById('degrees_of_separation').value = original.degrees_of_separation ?? 0;
            // Set scraping frequency and unit based on original value in minutes
            const freqInMinutes = original.scraping_frequency ?? 1440;
            let freq, unit;
            if (freqInMinutes >= 1440 && freqInMinutes % 1440 === 0) {
                freq = freqInMinutes / 1440;
                unit = 'days';
            } else if (freqInMinutes >= 60 && freqInMinutes % 60 === 0) {
                freq = freqInMinutes / 60;
                unit = 'hours';
            } else {
                freq = freqInMinutes;
                unit = 'minutes';
            }
            document.getElementById('scraping_frequency').value = freq;
            document.getElementById('frequency_unit').value = unit;
            
            // Initialize custom tooltips
            initCustomTooltips();
        }
        function computePatch() {
            const countryEl = document.getElementById('country');
            const languageEl = document.getElementById('language');
            const current = {
                name: document.getElementById('name').value.trim() || null,
                base_url: document.getElementById('base_url').value.trim() || null,
                source_type: document.getElementById('source_type').value || null,
                country: countryEl.options[countryEl.selectedIndex]?.dataset?.name || (countryEl.value || null),
                country_code: countryEl.value || null,
                language: languageEl.options[languageEl.selectedIndex]?.dataset?.name || (languageEl.value || null),
                language_code: languageEl.value || null,
                degrees_of_separation: parseInt(document.getElementById('degrees_of_separation').value, 10),
                scraping_frequency: (() => {
                    const freq = parseInt(document.getElementById('scraping_frequency').value, 10) || 1;
                    const unit = document.getElementById('frequency_unit').value;
                    if (unit === 'minutes') return freq;
                    if (unit === 'hours') return freq * 60;
                    if (unit === 'days') return freq * 1440;
                    return freq;
                })(),
            };
            const patch = {};
            for (const [k, v] of Object.entries(current)) {
                if (JSON.stringify(v) !== JSON.stringify(original[k] ?? null)) patch[k] = v;
            }
            return patch;
        }
        saveBtn.onclick = async () => {
            alertEl.className = 'alert d-none';
            const patch = computePatch();
            try {
                const resp = await fetch(`${apiBase}/scraping-sources/${id}`, { method: 'PUT', headers: authHeaders(), body: JSON.stringify(patch) });
                if (!resp.ok) throw new Error('Failed to save changes');
                window.location.href = '/app/dashboard.html';
            } catch (err) {
                alertEl.textContent = err.message || 'Failed to save changes';
                alertEl.className = 'alert alert-danger';
            }
        };

        // Delete functionality
        const deleteBtn = document.getElementById('delete');
        deleteBtn.onclick = async () => {
            const feedName = original?.name || 'this feed';
            const confirmed = confirm(`‚ö†Ô∏è Are you sure you want to delete "${feedName}"?\n\nThis action cannot be undone and will stop all scheduled scraping for this feed.`);

            if (!confirmed) return;

            alertEl.className = 'alert d-none';
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'üóëÔ∏è Deleting...';

            try {
                const resp = await fetch(`${apiBase}/scraping-sources/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error || 'Failed to delete feed');
                }

                alertEl.textContent = '‚úÖ Feed deleted successfully. Redirecting...';
                alertEl.className = 'alert alert-success';

                setTimeout(() => {
                    window.location.href = '/app/dashboard.html';
                }, 1500);

            } catch (err) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'üóëÔ∏è Delete Feed';
                alertEl.textContent = err.message || 'Failed to delete feed';
                alertEl.className = 'alert alert-danger';
            }
        };

        init();
        
        // Custom tooltip functionality
        function initCustomTooltips() {
            const tooltipTriggers = document.querySelectorAll('.tooltip-trigger');
            let currentTooltip = null;
            
            tooltipTriggers.forEach(trigger => {
                trigger.addEventListener('mouseenter', function(e) {
                    // Remove any existing tooltip
                    if (currentTooltip) {
                        currentTooltip.remove();
                    }
                    
                    // Create new tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    tooltip.textContent = this.getAttribute('data-tooltip');
                    document.body.appendChild(tooltip);
                    currentTooltip = tooltip;
                    
                    // Position tooltip
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                    tooltip.style.top = (rect.top - tooltip.offsetHeight - 8) + 'px';
                    tooltip.style.display = 'block';
                });
                
                trigger.addEventListener('mouseleave', function() {
                    if (currentTooltip) {
                        currentTooltip.remove();
                        currentTooltip = null;
                    }
                });
            });
        }
    </script>
</body>

</html>