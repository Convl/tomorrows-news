<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Topic ‚Ä¢ Tomorrow's News</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="/app/assets/theme.css" rel="stylesheet" />
    <style>
        .custom-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 400px;
            z-index: 1050;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            white-space: pre-line;
            display: none;
        }
        .custom-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: #333;
        }
        .tooltip-trigger {
            position: relative;
        }
    </style>
</head>

<body class="bg-light">
    <main class="container py-5">
        <div class="main-container">
            <a href="/app/dashboard.html" class="btn btn-link mb-4">‚Üê Back</a>
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="icon-placeholder icon-topic me-3">üìö</div>
                        <h1 class="h4 mb-0 fw-semibold">Edit Topic</h1>
                    </div>
                    <div id="alert" class="alert d-none" role="alert"></div>
                    <div id="form"></div>
                    <div class="d-grid gap-2 mt-4">
                        <button id="save" class="btn btn-primary">üíæ Save Changes</button>
                        <button id="delete" class="btn btn-outline-danger">üóëÔ∏è Delete Topic</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="/app/js/config.js"></script>
    <script type="module" src="/app/js/choices.js"></script>
    <script type="module">
        import { apiBase, authHeaders, getToken } from '/app/js/config.js';
        import { populateSelect } from '/app/js/choices.js';
        const alertEl = document.getElementById('alert');
        if (!getToken()) { window.location.href = '/app/login.html'; }
        const params = new URLSearchParams(window.location.search);
        const id = parseInt(params.get('id'), 10);
        const formRoot = document.getElementById('form');
        formRoot.innerHTML = `
            <div class="mb-4">
              <label class="form-label" for="name">üìù Name 
                <span class="text-info ms-1 tooltip-trigger" data-tooltip="A succinct name for the topic about which upcoming events shall be gathered, e.g. 'Law & Legislation in Germany', 'International developments in artificial intelligence', 'Anything and everything having to do with UFOS'. The value in this field will be passed to the LLM that assists in the event extraction, and will directly impact the results that you see in your dashboard." style="cursor: help;">‚ÑπÔ∏è</span>
              </label>
              <input class="form-control" id="name" placeholder="Enter topic name..." />
            </div>
            <div class="mb-4">
              <label class="form-label" for="description">üìÑ Description 
                <span class="text-info ms-1 tooltip-trigger" data-tooltip="A more detailed description of the topic and the kinds of events you are interested in, e.g.: 'Court cases and legislative proceedings in Germany that are significant enough to be of interest to the general public', 'Only focus on A.I. developments that are likely to impact the job market for software engineers within the next 12 months', 'I particularly care about UFO- and Alien-related Festivals and conventions'. The value in this field will be passed to the LLM that assists in the event extraction, and will directly impact the results that you see in your dashboard." style="cursor: help;">‚ÑπÔ∏è</span>
              </label>
              <textarea class="form-control" id="description" rows="3" placeholder="Describe what this topic covers..."></textarea>
            </div>
        `;
        const saveBtn = document.getElementById('save');
        let original = null;
        async function init() {
            const resp = await fetch(`${apiBase}/topics/${id}`, { headers: authHeaders() });
            if (!resp.ok) { alertEl.textContent = 'Failed to load topic'; alertEl.className = 'alert alert-danger'; return; }
            original = await resp.json();
            document.getElementById('name').value = original.name || '';
            document.getElementById('description').value = original.description || '';
            
            // Initialize custom tooltips
            initCustomTooltips();
        }
        function computePatch() {
            const current = {
                name: document.getElementById('name').value.trim() || null,
                description: document.getElementById('description').value.trim() || null,
            };
            const patch = {};
            for (const [k, v] of Object.entries(current)) {
                if (JSON.stringify(v) !== JSON.stringify(original[k] ?? null)) patch[k] = v;
            }
            return patch;
        }
        saveBtn.onclick = async () => {
            alertEl.className = 'alert d-none';
            const patch = computePatch();
            try {
                const resp = await fetch(`${apiBase}/topics/${id}`, { method: 'PUT', headers: authHeaders(), body: JSON.stringify(patch) });
                if (!resp.ok) throw new Error('Failed to save changes');
                window.location.href = '/app/dashboard.html';
            } catch (err) {
                alertEl.textContent = err.message || 'Failed to save changes';
                alertEl.className = 'alert alert-danger';
            }
        };

        // Delete functionality
        const deleteBtn = document.getElementById('delete');
        deleteBtn.onclick = async () => {
            const topicName = original?.name || 'this topic';
            const confirmed = confirm(`‚ö†Ô∏è Are you sure you want to delete "${topicName}"?\n\nThis action cannot be undone and will also delete all associated feeds and events.`);

            if (!confirmed) return;

            alertEl.className = 'alert d-none';
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'üóëÔ∏è Deleting...';

            try {
                const resp = await fetch(`${apiBase}/topics/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error || 'Failed to delete topic');
                }

                alertEl.textContent = '‚úÖ Topic deleted successfully. Redirecting...';
                alertEl.className = 'alert alert-success';

                setTimeout(() => {
                    window.location.href = '/app/dashboard.html';
                }, 1500);

            } catch (err) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'üóëÔ∏è Delete Topic';
                alertEl.textContent = err.message || 'Failed to delete topic';
                alertEl.className = 'alert alert-danger';
            }
        };

        init();
        
        // Custom tooltip functionality
        function initCustomTooltips() {
            const tooltipTriggers = document.querySelectorAll('.tooltip-trigger');
            let currentTooltip = null;
            
            tooltipTriggers.forEach(trigger => {
                trigger.addEventListener('mouseenter', function(e) {
                    // Remove any existing tooltip
                    if (currentTooltip) {
                        currentTooltip.remove();
                    }
                    
                    // Create new tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    tooltip.textContent = this.getAttribute('data-tooltip');
                    document.body.appendChild(tooltip);
                    currentTooltip = tooltip;
                    
                    // Position tooltip
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                    tooltip.style.top = (rect.top - tooltip.offsetHeight - 8) + 'px';
                    tooltip.style.display = 'block';
                });
                
                trigger.addEventListener('mouseleave', function() {
                    if (currentTooltip) {
                        currentTooltip.remove();
                        currentTooltip = null;
                    }
                });
            });
        }
    </script>
</body>

</html>